<Style>
    .wrapper {
        display: grid;
        grid-template-columns: 1fr 3fr;
    }
</Style>

{% extends 'base.html' %} {% block content %}


<h1>location_get_test</h1>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
crossorigin=""/>

<div class="wrapper">
    <div>
        {% csrf_token %}

        <div id="displaybox">
            <div id="map"></div>
            <style>
                #map { height: 180px; }
            </style>
        </div>

    </div>
</div>

<script>
    


    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const displaybox = document.getElementById("displaybox");

    // this function starts the location watcher
    function startLocator() {
        if (navigator.geolocation) {
            // watchposition ties a method to every time the user's location changes;
            // here it'll run showposition, using the getposition return values as the args
            navigator.geolocation.watchPosition(postPosition);

            // should note that watchposition has an option for a function to run in case of error
            // and also options: maximumAge, timeout, enableHighAccuracy. should use these.
        } else {
            displaybox.innerHTML = "geolocation is not supported by this browser";
        }
    }

    function showPosition(position) {
        // formatting location data
        var addedLoc = position.coords.latitude + ", " +
            position.coords.longitude +
            " at " + position.timestamp;

        // creating text and p elements
        var newloc = document.createTextNode(addedLoc);
        var pelem = document.createElement("p");

        // applying these to the displaybox 
        pelem.appendChild(newloc);
        displaybox.appendChild(pelem);
    }

    function postPosition(position) {
        var req = new XMLHttpRequest();
        var url = "/location_get_test/";

        req.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                alert("200");
            } else if (this.readyState == 4 && this.status != 200) {
                alert("!200");
            }
        };
        
        req.open("POST", url);
        req.setRequestHeader('X-CSRFToken', csrftoken)
        req.setRequestHeader("Content-Type", "application/json;charset=UTF-8");

        req.send(JSON.stringify(posToObject(position)));
    }

    // This is required to be able to properly strigify the result from geolocation fetching
    function posToObject (position) {
        // there might be more data worth returning but this is probably what's useful to us
        return {
          timestamp: position.timestamp,
          coords: {
            accuracy: position.coords.accuracy,
            latitude: position.coords.latitude,
            longitude: position.coords.longitude,
          }
        }
    }

    window.onload = function(){
        //startLocator();
        var map = L.map('map').setView([51.505, -0.09], 13);
        L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
            maxZoom: 18,
            id: 'mapbox/streets-v11',
            tileSize: 512,
            zoomOffset: -1,
            accessToken: 'your.mapbox.access.token'
        }).addTo(map);
    };
</script>

 <!-- Make sure you put this AFTER Leaflet's CSS -->
 <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
   integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
   crossorigin=""></script>

{% endblock %}