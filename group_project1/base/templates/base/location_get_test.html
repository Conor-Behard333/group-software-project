<Style>
    .wrapper {
        display: grid;
        grid-template-columns: 1fr 3fr;
    }
</Style>

{% extends 'base.html' %} {% block content %}


<h1>location_get_test</h1>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
crossorigin=""/>

<div class="wrapper">
    <div>
        {% csrf_token %}

        <div id="displaybox">
            <div id="map"></div>
            <style>
                #map { height: 500px; width: 1000px }
            </style>
        </div>

    </div>
</div>

<script>
    


    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const displaybox = document.getElementById("displaybox");

    // this function starts the location watcher
    function startLocator(map) {
        if (navigator.geolocation) {
            // watchposition ties a method to every time the user's location changes;
            // here it'll run displayposition, using the getposition return values as the args
            function success (position){
                displayPosition( map, position );
            }

            function error(err) {
                console.warn('ERROR(' + err.code + '): ' + err.message);
            }

            options = {
                enableHighAccuracy: true,
                timeout: 5000,
                maximumAge: 0
            };
            
            navigator.geolocation.watchPosition(success, error, options);

            // should note that watchposition has an option for a function to run in case of error
            // and also options: maximumAge, timeout, enableHighAccuracy. should use these.
        } else {
            console.log("User has declined geolocation access");
        }
    }

    function displayPosition(map, position) {
        L.marker([position.coords.latitude, position.coords.longitude]).addTo(map);
        showPosition(position);
    }

    function showPosition(position) {
        // formatting location data
        var addedLoc = position.coords.latitude + ", " +
            position.coords.longitude +
            " at " + position.timestamp;

        console.log(addedLoc);
    }

    function postPosition(position) {
        var req = new XMLHttpRequest();
        var url = "/location_get_test/";

        req.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                alert("200");
            } else if (this.readyState == 4 && this.status != 200) {
                alert("!200");
            }
        };
        
        req.open("POST", url);
        req.setRequestHeader('X-CSRFToken', csrftoken)
        req.setRequestHeader("Content-Type", "application/json;charset=UTF-8");

        req.send(JSON.stringify(posToObject(position)));
    }

    // This is required to be able to properly strigify the result from geolocation fetching
    function posToObject (position) {
        // there might be more data worth returning but this is probably what's useful to us
        return {
          timestamp: position.timestamp,
          coords: {
            accuracy: position.coords.accuracy,
            latitude: position.coords.latitude,
            longitude: position.coords.longitude,
          }
        }
    }


    // Initializing everything
    window.onload = function(){
        // map border
        var swest = L.latLng(50.729748, -3.520532),
            neast = L.latLng(50.741780, -3.548116),
            bounds = L.latLngBounds(swest, neast);

        var map = L.map('map').setView([50.735805, -3.533051], 15);

        // mapbox is also a good tileset for this
        L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
            maxBounds: bounds,
            maxZoom: 18,
            minZoom: 14,
            tileSize: 512,
            zoomOffset: -1,
        }).addTo(map);

        // This draws a polygon around the playable area
        var areamarker = [
            [ // Exterior Ring
                [90, -180],
                [90, 180],
                [-90, 180],
                [-90, -180]
            ], // Then holes (interior rings)
            [ // First hole
                [50.729748, -3.520532],
                [50.729748, -3.548116],
                [50.741780, -3.548116],
                [50.741780, -3.520532]
            ]
        ];

        // adding polygon to map
        L.polygon(areamarker, {color: "#ff2600", weight: 2, interactive: false}).addTo(map);

        map.setMaxBounds(map.getBounds());

        startLocator(map);
    };
</script>

 <!-- Make sure you put this AFTER Leaflet's CSS -->
 <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
   integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
   crossorigin=""></script>

{% endblock %}